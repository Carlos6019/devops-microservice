name: build and deploy

on:
  push:
    branches: master
  workflow_call:
    inputs:
      qltyCoverage:
        description: "Qlty Coverage"
        required: false
        type: string
        default: "false"
      qltyCoverageFiles:
        description: "Qlty Coverage Files (glob patterns or comma-separated paths)"
        required: false
        type: string

env:
  AWS_REGION: us-east-1
  ECR_REPO: devops-microservice
  CLUSTER_NAME: devops-eks-cluster
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  build:
    name: Build-plan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Setup AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init

      - name: Install Qlty CLI
        if: ${{ inputs.qltyCoverage == 'true' || github.event_name == 'push' }}
        run: |
          curl -fsSL https://qlty.sh | bash
          echo "$HOME/.qlty/bin" >> $GITHUB_PATH
          export PATH="$HOME/.qlty/bin:$PATH"
          qlty version || echo "Qlty CLI installed but version not detected"
      - name: Run Qlty Analysis
        if: ${{ inputs.qltyCoverage == 'true' || github.event_name == 'push' }}
        run: |
          set -e
          export PATH="$HOME/.qlty/bin:$PATH"
          export QLTY_DISABLE_ESLINT=true

          # Inicializar Qlty si no existe configuraci√≥n
          if [ ! -f .qlty/qlty.toml ]; then
            echo "Initializing Qlty configuration..."
            qlty init --yes
          fi

          echo "::group::Qlty Code Analysis"
          # Ejecutar Qlty y exportar resultados en JSON sin romper el pipeline
          qlty check --all --format json > qlty-results.json || true
          echo "::endgroup::"

          echo "üìÑ Archivo generado: qlty-results.json"
          cat qlty-results.json || echo "‚ö†Ô∏è No se gener√≥ archivo de resultados"

          # Procesar cobertura localmente (sin subir a cloud)
          if [ -n "${{ inputs.qltyCoverageFiles }}" ]; then
            echo "::group::Qlty Coverage Analysis"
            qlty coverage publish --dry-run ${{ inputs.qltyCoverageFiles }} || true
            echo "::endgroup::"
          fi

      - name: Upload Qlty Results
        if: ${{ inputs.qltyCoverage == 'true' || github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: qlty-results
          path: qlty-results.json



      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan

  deploy:
    needs: build
    name: Deploy-plan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Setup AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: .

      - name: Terraform Destroy
        run: terraform destroy -auto-approve
